!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["skyline-component-image-capture"]=t():e["skyline-component-image-capture"]=t()}(window,(function(){return function(e){var t={};function s(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}return s.m=e,s.c=t,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(i,r,function(t){return e[t]}.bind(null,r));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";if(s.r(t),!window.jQuery)throw new Error("The skyline component 'image-capture' requires jquery.");var i=window.jQuery;class r{renderTemplate(){}reset(){}}class n extends r{get template(){return""}renderTemplate(){const e=i(this.template);return this.bindTemplate(e),e}bindTemplate(e){}reset(){}checkImage(e,t){}}const a={modal_title:"Upload New Image",modal_close:"Close",modal_description:"Here you can choose and upload images to your application",modal_cancel:"Cancel",modal_accept:"Upload",modal_drop_zone_text:"Or drop file here…",source_local_file:"Disk",source_remote_file:"URL",source_remote_file_load:"Load…",source_camera:"Camera",source_camera_error:"Could not init or load from camera.",source_camera_capture:"Capture",source_camera_default_name:"captured.jpg",source_current_delete:"Delete",quality_title:"Quality",quality_perfect:"Perfect",quality_OK:"OK",quality_sufficient:"Sufficient",quality_scarce:"Scarce",quality_insufficient:"insufficient",ratio_title:"Aspect Ratio",ratio_bad:"Bad ratio (required 16:9 until 1:1)",dimension_title:"Dimension",size_title:"Size",property_slug_error:"Slug must only contain latin characters",image_load_error:"Could not load the image.",property_slug_label:"Slug",property_slug_placeholder:"my-file",property_caption_label:"Caption",property_caption_placeholder:"My Image",property_alt_label:"Alt",property_alt_placeholder:"Text in error case",options_label:"Options",option_scale_to_best:"Scale to optimal size",option_render_preview:"Render preview",option_make_watermark:"Render Watermark",option_make_main:"Make main image"};class o extends n{get template(){return'<li class="list-group-item d-flex justify-content-between p-1">\n                                <strong>'+a.quality_title+"</strong>\n                                <span></span>\n                            </li>\n"}static get IMAGE_BREAKPOINTS(){return[{q:767,l:a.quality_scarce,c:"warning",ok:!0},{q:1023,l:a.quality_sufficient,c:"warning",ok:!0},{q:1439,l:a.quality_OK,c:"success",ok:!0},{q:1919,l:a.quality_perfect,c:"success",ok:!0}]}static get ICON_BREAKPOINTS(){return[{q:99,l:a.quality_scarce,c:"warning",ok:!0},{q:256,l:a.quality_sufficient,c:"warning",ok:!0},{q:511,l:a.quality_OK,c:"success",ok:!0},{q:1023,l:a.quality_perfect,c:"success",ok:!0}]}constructor(e){super(),"function"==typeof e.sort&&e.sort((e,t)=>e.q<t.q?-1:e.q>t.q?1:0),this.breakpoints=e}bindTemplate(e){this.boundClass=e,this.boundQ=e.find("span")}reset(){this.boundClass.removeClass("list-group-item-success").removeClass("list-group-item-warning").removeClass("list-group-item-danger"),this.boundQ.html("")}checkImage(e,t){let s=Math.max(e.width,e.height),i="danger",r=a.quality_insufficient,n=!1;return this.breakpoints.forEach(e=>{s>e.q&&(i=e.c,r=e.l,n=e.ok)}),""!==i&&this.boundClass.addClass("list-group-item-"+i),this.boundQ.html(r),n}}class l extends n{constructor(e){super(),this.ratio=e}get template(){return'<li class="list-group-item d-flex justify-content-between p-1 list-group-item-danger">\n                                <strong>'+a.ratio_title+"</strong>\n                                <span>"+a.ratio_bad+"</span>\n                            </li>\n"}bindTemplate(e){this.bound=e}reset(){this.bound.addClass("d-none").removeClass("d-flex")}checkImage(e,t){var s=e.width/e.height;return s<this.ratio&&s>1/this.ratio?(this.bound.addClass("d-none").removeClass("d-flex"),!0):(this.bound.removeClass("d-none").addClass("d-flex"),!1)}}class c extends n{get template(){return'<li class="list-group-item d-flex justify-content-between p-1">\n                                <strong>'+a.dimension_title+"</strong>\n                                <span></span>\n                            </li>\n"}bindTemplate(e){this.bound=e.find("span")}reset(){this.bound.html("")}checkImage(e,t){return this.bound.html(e.width+"x"+e.height),!0}}const d=({id:e,label:t,icon:s})=>'<div class="form-group row">\n                            <label for="'+e+'" class="col-lg-2 col-form-label">'+t+'</label>\n                            <div class="col-lg-10">\n                                <div class="input-group">\n                                    <div class="input-group-prepend">\n                                        <span class="input-group-text"><i class="fa '+s+'"></i></span>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n';if(!window.Skyline)throw new Error("The skyline component 'image-capture' requires component Skyline.");var h=window.Skyline;class p extends r{get template(){return({id:e,placeholder:t})=>""}constructor({name:e,label:t=null,icon:s=null,placeholder:r=""}){super(),this.id=h.guid(),this.name=e,this.renderTemplate=()=>{const e=i(d({id:this.id,label:t,icon:s})),n=i("function"==typeof this.template?this.template({id:this.id,placeholder:r}):this.template);return this.bindTemplate(e,n),e}}renderTemplate(){}bindTemplate(e,t){e.find(".input-group").append(t),this.bound=e,this.boundI=t}get value(){return this.boundI.val()}validate(e,t){return!0}willAppear(e,t){}}class u{constructor(e,t){this.el=t,this._skip_c=!1,this._emitter=e,t.on("hide.bs.modal",()=>{this._skip_c||(e.sources.forEach(e=>e.deselect()),e.trigger("cancel"))}),this.checkerEl=t.find(".list-group"),this.frameEl=t.find(".frame-set"),this.propertyEl=t.find(".property-container"),this.optionEl=t.find(".option-container"),this.optionLbl=t.find(".options-label"),this.sourcesElM=t.find(".sources"),this.sourcesEl=t.find(".sources .tab-content"),this.sourcesTabEl=t.find(".sources .nav"),this.fileInfo=t.find(".file-info"),this.imageEl=this.fileInfo.find("img")[0],this.progressEl=t.find(".progress"),this.saveButton=t.find("button[data-role='update']"),this.checkers=new Map,this.properties=new Map,this.options=new Map,this.sources=new Map,this.selectedSource=null,this.frame=null,this.saveButton.on("click",t=>e.validateAndSave())}runModal(){this.sourcesElM.show(),this.fileInfo.hide(),this.progressEl.hide(),this.fileInfo.find("alert").remove(),this.saveButton.attr("disabled","disabled"),this.el.modal("show")}presentError(e,t){this.fileInfo.prepend("<div class='alert alert-"+t+"'>"+e+"</div>")}addSource(e){if(!this.sources.has(e)){const t=e.renderTemplate(),s=$('<div class="tab-pane fade" role="tabpanel"></div>');s.append(t),this.sourcesEl.append(s);const i=$("<li class='nav-item' role='presentation'><a class=\"nav-link ic-tab-item\" href='#' onclick='return false;'>"+e.name+"</a></li>");i.on("click",()=>{this._emitter.selectSource(e)}),this.sources.set(e,{w:s,t:i}),this.sourcesTabEl.append(i)}}select(e){if(e&&this.selectedSource!==e){this.selectedSource&&this.selectedSource.deselect(),this.selectedSource=e;const t=this.sources.get(e);if(t){const{w:e,t:s}=t;this.sourcesTabEl.find("li a").removeClass("active"),s.find("a").addClass("active"),this.sourcesEl.find(".tab-pane").removeClass("show").removeClass("active"),e.addClass("active").addClass("show")}}}removeSource(e){if(this.sources.has(e)){const{w:t,t:s}=this.sources.get(e);this.selectedSource===e&&(e.deselect(),this.selectedSource=null,this.sourcesTabEl.find("li a").removeClass("active"),this.sourcesEl.find(".tab-pane").removeClass("show").removeClass("active")),t.remove(),s.remove(),this.sources.delete(e)}}setupFrame(e){this.frame&&this.frame.remove(),this.frame=e.renderTemplate(),this.frameEl.append(this.frame)}addChecker(e){if(!this.checkers.has(e)){const t=e.renderTemplate();this.checkerEl.append(t),this.checkers.set(e,t)}}removeChecker(e){if(this.checkers.has(e)){this.checkers.get(e).remove(),this.checkers.delete(e)}}addProperty(e){if(!this.properties.has(e)){const t=e.renderTemplate();this.propertyEl.append(t),this.properties.set(e,t)}}removeProperty(e){if(this.properties.has(e)){this.properties.get(e).remove(),this.properties.delete(e)}}addOption(e){if(!this.options.has(e)){const t=e.renderTemplate();this.optionEl.append(t),this.options.set(e,t),this.optionLbl.removeClass("d-none")}}removeOption(e){if(this.options.has(e)){this.options.get(e).remove(),this.options.delete(e),this.options.size<1&&this.optionLbl.addClass("d-none")}}}const m=(e,t,s)=>"<div><input id='option-"+e+'\' class="sky-checkbox" type="checkbox" value="'+t+'"> <label for="option-'+e+'">'+s+"</label></div>";class f{constructor(e){this.events=e instanceof f?e.events:e.handlers,this.plugins=new Map}use(e,t){if(e.name&&this.plugins.has(e.name))throw new Error(`Plugin ${e.name} already in use`);e.install(this,t||{}),this.plugins.set(e.name,e)}on(e,t){return("string"==typeof e?e.split(" "):e).forEach(e=>{if(!this.events[e])throw new Error(`The event ${e} does not exist`);this.events[e].push(t)}),this}trigger(e,t){if(!(e in this.events))throw new Error(`The event ${e} cannot be triggered`);let s=!0,i=this;return this.events[e].forEach(e=>{"function"==typeof e&&(s=e.call(i,t)&&s)}),s}bind(e){if(this.events[e])throw new Error(`The event ${e} is already bound`);this.events[e]=[]}exists(e){return Array.isArray(this.events[e])}}class g{constructor(){this.handlers={update:[],error:[console.error],save:[],delete:[],cancel:[]}}}class v extends r{constructor(){super(),this.handlers=[],this.selectByDefault=!0}get template(){return""}get name(){return""}renderTemplate(){const e=i(this.template);return this.bindTemplate(e),e}select(){}deselect(){}bindTemplate(e){}reset(){}handler(e){"function"==typeof e&&this.handlers.push(e)}handle(e){this.handlers.forEach(t=>t(e))}}class b{get template(){return""}renderTemplate(){const e=i(this.template);return this.bindTemplate(e),e}bindTemplate(e){this.boundImage=e.find("img")}reset(){}loadImage({file:e,image:t,complete:s,error:i}){this.boundImage[0].onload=s,this.boundImage[0].onerror=i,this.boundImage[0].src=t.src}saveProperties(e){}}class w extends b{get template(){return'<figure class="figure w-100 text-center">\n                            <img class="w-75 img-fluid rounded shadow" src="" alt="">\n                        </figure>'}}const y={FILE_SIZE:2e6,UPLOADS:20,POST_SIZE:8e6},_={panel:()=>'<div class="modal fade" id="sky-it-capture-modal" tabindex="-1" role="dialog" aria-labelledby="sky-it-capture-modal-titel"\n     aria-hidden="true">\n    <div class="modal-dialog" role="document">\n        <div class="modal-content">\n            <div class="modal-header alert-primary">\n                <h5 class="modal-title" id="sky-it-capture-modal-titel">'+a.modal_title+'</h5>\n                <button type="button" class="close" data-dismiss="modal" aria-label="'+a.modal_close+'">\n                    <span aria-hidden="true">&times;</span>\n                </button>\n            </div>\n            <div class="modal-body">\n                    <p>\n'+a.modal_description+'                    </p>\n                    <div class=\'sources\'><ul class=\'nav nav-tabs\' role=\'tablist\'></ul>\n<div class="tab-content">\n</div></div>                           <div class="file-info"><div class=\'frame-set\'></div>\n                        <ul class="list-group">\n                        </ul>\n\n                        <hr class="my-2">\n                        <div class=\'property-container\'></div>                            <div class="form-group row">\n                            <label for="" class="col-lg-2 col-form-label options-label d-none">'+a.options_label+'</label>\n                            <div class="col-md-9 pt-1">\n                                <div class="option-container"></div>\n                            </div>\n                        </div>\n                        <div class="progress">\n                            <div class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25"\n                                 aria-valuemin="0" aria-valuemax="100">25%\n                            </div>\n                        </div>\n            </div>\n        </div>\n        <div class="modal-footer d-flex justify-content-between">\n            <button type="button" class="btn btn-sm btn-outline-danger" data-dismiss="modal">'+a.modal_cancel+'</button>\n            <button type="button" class="btn btn-sm btn-outline-success" data-role="update">'+a.modal_accept+"</button>\n        </div>\n    </div>\n</div>",property:d,option:m};class k extends f{static get LIMITS(){return y}static get TEMPLATES(){return _}static get TRANSLATIONS(){return a}constructor(e,{checkers:t=null,properties:s=null,options:i=null,sources:r=null,frame:n=null}){super(new g),this.checkers=[],this.properties=new Map,this.options=new Map,this.sources=new Map,this.reference=e,this.setupFrame(n),t&&t.forEach(e=>this.addChecker(e)),s&&s.forEach(e=>this.addProperty(e)),i&&i.forEach(e=>this.addOption(e)),r&&r.forEach(e=>this.addSource(e))}get view(){if(!this._view){const e=i(_.panel());i(document.body).append(e),this._view=new u(this,e)}return this._view}addSource(e){return e instanceof v&&(this.sources.set(e.name,e),e.handler(t=>{this.sources.has(e.name)&&this.updateFromInput(t)}),this.view.addSource(e),e.selectByDefault&&this.selectSource(e),e.emitter=this),this}removeSource(e){e instanceof v&&(e=e.name);const t=this.sources.get(e);return t&&this.view.removeSource(t),this.sources.delete(e),this}clearSources(){this.sources.forEach(e=>this-this.removeSource(e))}selectSource(e){e instanceof v&&(e.select(),this.view.select(e))}setupFrame(e){e instanceof b?(this.frame=e,this.view.setupFrame(e)):this.setupFrame(new w)}addChecker(e){return e instanceof n&&(this.checkers.push(e),this.view.addChecker(e)),this}removeChecker(e){const t=this.checkers.indexOf(e);return!1!==t&&(delete this.checkers[t],this.view.removeChecker(e)),this}clearCheckers(){this.checkers.forEach(e=>this-this.removeChecker(e))}addProperty(e){return e instanceof p&&(this.properties.set(e.name,e),this.view.addProperty(e)),this}removeProperty(e){e instanceof p&&(e=e.name);const t=this.properties.get(e);return t&&this.view.removeProperty(t),this.properties.delete(e),this}clearProperties(){this.properties.forEach(e=>this-this.removeProperty(e))}addOption(e){return"number"==typeof e.id&&(this.options.set(e.id,e),this.view.addOption(e)),this}removeOption(e){"object"==typeof e&&(e=e.id);const t=this.options.get(e);return t&&this.view.removeOption(t),this.options.delete(e),this}clearOptions(){this.options.forEach(e=>this-this.removeOption(e))}run(e){this.checkers.forEach(e=>e.reset()),this.properties.forEach(e=>e.reset()),this.sources.forEach(e=>e.reset()),this.frame.reset(),this.view.propertyEl.find(".alert").remove(),this.view.runModal()}updateFromInput(e){if(!e)throw new Error("image capture did not receive any file.");if(/^image\/.+/.test(e.type)){var t=new FileReader;t.onload=()=>{this.file=e;const s=new Image;this.image=s,s.src=t.result,this.frame.loadImage({file:e,image:s,complete:()=>{this.view.fileInfo.show(),this.view.sourcesElM.hide(),this.view.selectedSource.deselect();let t=!0;this.checkers.forEach(i=>{t=i.checkImage(s,e)&&t}),this.properties.forEach(t=>t.willAppear(s,e)),this.options.forEach(t=>{"function"==typeof t.willAppear&&t.willAppear(s,e,this.view.options.get(t).find("input")[0])}),t&&this.view.saveButton.attr("disabled",!1),this.trigger("update",{file:e,image:s})},error:()=>{this.view.presentError(a.image_load_error,"error"),this.trigger("error")}})},t.readAsDataURL(e)}}validateAndSave(){this.view.propertyEl.find(".alert").remove();try{this.properties.forEach(e=>{e.validate(this.image,this.file)});const e={};this.properties.forEach(t=>e[t.name]=t.value);let t=0;this.options.forEach(e=>{t|=e.value}),this.view.progressEl.show();const s=e=>{e=Math.round(100*e),this.view.progressEl.find(".progress-bar").css("width",e+"%").attr("aria-valuenow",e).text(e+"%")};s(0),this.frame.saveProperties(e),this.trigger("save",{file:this.file,image:this.image,options:t,properties:e,progress:s,done:()=>{this.view._skip_c=!0,this.cancel(),this.view._skip_c=!1},error:e=>{this.view.progressEl.hide(),this.view.propertyEl.prepend("<div class='alert alert-danger'>"+e+"</div>")}})}catch(e){this.view.propertyEl.prepend("<div class='alert alert-danger'>"+e.message+"</div>")}}cancel(){this.view.el.modal("hide")}}class E extends n{get template(){return'<li class="list-group-item d-flex justify-content-between p-1">\n                                <strong>'+a.size_title+"</strong>\n                                <span></span>\n                            </li>\n"}bindTemplate(e){this.bound=e,this.boundQ=e.find("span")}reset(){this.bound.removeClass("list-group-item-danger"),this.boundQ.html("-.-")}checkImage(e,t){return this.boundQ.html(h.Byte.format(t.size)),!(t.size>y.FILE_SIZE||t.size>y.POST_SIZE)||(this.bound.addClass("list-group-item-danger"),!1)}}class x extends p{get template(){return({id:e,placeholder:t})=>'<input type="text" class="form-control" placeholder="'+t+'" id="'+e+'" value="">'}}class S extends x{bindTemplate(e,t){super.bindTemplate(e,t);const s=i('<div class="input-group-append"><span class="input-group-text"></span></div>');this.boundE=s.find("span"),e.find(".input-group").append(s)}validate(e,t){if(/^[a-zA-Z0-9_.\-]+$/.test(this.value))return!0;throw new Error(a.property_slug_error)}get value(){let e=super.value;return"."+e.split(".").pop()===this.boundE.text()?e:e+this.boundE.text()}willAppear(e,t){let s=t.name.replace(/[^a-zA-Z0-9_.]/g,"-");s=s.split("."),this.extension=s.pop().toLowerCase(),this.boundE.text("."+this.extension),this.boundI.val(s.join("."))}}class I extends p{get template(){return({id:e,placeholder:t})=>'<textarea class="form-control" rows="3" placeholder="'+t+'" id="'+e+'"></textarea>'}}class C extends r{constructor({id:e,label:t,checkedByDefault:s=!1}){super(),this.id=e,this.label=t,this.checked=s,this.renderTemplate=()=>{const e=i(m(this.id,this.id,t));return this.bindTemplate(e),e}}get value(){return this.boundI[0].checked?1*this.boundI[0].value:0}reset(){this.boundI[0].checked=this.checked}bindTemplate(e){this.bound=e,this.boundI=e.find("input")}willAppear(e,t,s){s.checked=this.checked}}class T extends C{constructor({id:e,label:t,checkedByDefault:s=!1}){super({id:e,label:t,checkedByDefault:s})}bindTemplate(e){super.bindTemplate(e),this.disable()}enable(){this.bound.removeClass("text-muted"),this.boundI.attr("disabled",!1)}disable(){this.bound.addClass("text-muted"),this.boundI.attr("disabled","disabled")}}class M extends v{get name(){return a.source_local_file}get template(){return'<div class="form-group file-select" data-placeholder="'+a.modal_drop_zone_text+'">\n                        <label> </label>\n                        <input type="file" class="form-control" accept=\'image/jpeg,image/png,image/gif,image/bmp,image/tiff\'>\n                    </div>'}bindTemplate(e){this.fileSelect=e,this.fileInput=this.fileSelect.find("input[type='file']"),this.fileInput.on("change",()=>{this.handle(this.fileInput[0].files[0])})}}class O extends v{get name(){return a.source_remote_file}get template(){return'<div class="input-group my-3">\n  <div class=\'input-group-prepend\'><span class="input-group-text">@</span></div> \n  <input type="text" class="form-control" placeholder="https://www.example.org/image.jpg">\n  <div class=\'input-group-append\'><button class=\'btn btn-outline-primary\' onclick=\'$(this).parent().parent().find("input").trigger("change")\'>'+a.source_remote_file_load+"</button></div></div>"}reset(){this.boundI.val("")}bindTemplate(e){this.bound=e,this.boundI=this.bound.find("input"),this.boundI.on("change",()=>{const e=h.API.setup.xhr();e.open("GET",this.boundI.val()),e.responseType="arraybuffer",e.onload=()=>{if(200!==e.status)this.boundI.addClass("is_invalid");else{const t=new Blob([e.response],{type:e.getResponseHeader("content-type"),name:"test"});t.name=this.boundI.val().split("/").pop(),this.handle(t)}},e.onerror=()=>{this.boundI.addClass("is_invalid")},e.send()}).on("input",()=>{this.boundI.removeClass("is_invalid")})}}class P extends v{constructor(){super(),this.selectByDefault=!1,this.stream=null}get name(){return a.source_camera}get template(){return"<div class='d-flex justify-content-center'><div class='d-inline-block position-relative mx-auto my-3'>\n    <video width='300' height='225'></video>\n    <button class=\"btn btn-sm btn-outline-danger\" style=\"position: absolute; bottom: 1em; left: 50%;\">"+a.source_camera_capture+"</button><div class='alert alert-danger'>"+a.source_camera_error+"</div>\n </div></div>"}bindTemplate(e){this.video=e.find("video"),this.error=e.find(".alert"),e.find("button").on("click",()=>{const e=document.createElement("canvas"),t=this.video[0];e.width=t.videoWidth,e.height=t.videoHeight;e.getContext("2d").drawImage(t,0,0,t.videoWidth,t.videoHeight),setTimeout(()=>{for(var t=atob(e.toDataURL("image/png").split(",")[1]),s=t.length,i=new Uint8Array(s),r=0;r<s;r++)i[r]=t.charCodeAt(r);const n=new Blob([i],{type:"image/png"});n.name=a.source_camera_default_name,this.handle(n)})})}presentError(e){console.log(e),this.error.show()}initWebcam(e){console.log("OK",e),this.stream=e;const t=this.video[0];t.width=t.offsetWidth,t.height=t.offsetHeight,"srcObject"in t?t.srcObject=e:window.webkitURL?t.src=window.webkitURL.createObjectURL(e):window.URL&&(t.src=window.URL.createObjectURL(e)),t.play()}select(){this.error.hide();const e={video:!0};try{navigator.mediaDevices.getUserMedia?navigator.mediaDevices.getUserMedia(e).then(e=>this.initWebcam(e)).catch(e=>this.presentError(e)):navigator.mediaDevices.webkitGetUserMedia?navigator.mediaDevices.webkitGetUserMedia(e).then(e=>this.initWebcam(e)).catch(e=>this.presentError(e)):navigator.mediaDevices.mozGetUserMedia?navigator.mediaDevices.mozGetUserMedia(e).then(e=>this.initWebcam(e)).catch(e=>this.presentError(e)):this.presentError()}catch(e){this.presentError(e)}}deselect(){if(this.stream){console.log("DESEL");const e=this.video[0];e.pause(),e.src="",e.srcObject=void 0,this.stream.getTracks().forEach(e=>e.stop())}}}const q=(e,t)=>(window.addEventListener(e,t),()=>{window.removeEventListener(e,t)});class D{constructor(e,t,s,i){this.pointerStart=null,this.el=e,this.ontranslate=t,this.onstart=s,this.ondrag=i,this.el.style.touchAction="none",this.el.addEventListener("pointerdown",this.down.bind(this));const r=q("pointermove",this.move.bind(this)),n=q("pointerup",this.up.bind(this));this.destroy=()=>{r(),n()}}down(e){e.stopPropagation(),this.pointerStart=[e.pageX,e.pageY],"function"==typeof this.onstart&&this.onstart(e)}move(e){if(this.pointerStart&&"function"==typeof this.ontranslate){e.preventDefault();let[t,s]=[e.pageX,e.pageY],i=[t-this.pointerStart[0],s-this.pointerStart[1]],r=this.el.getBoundingClientRect().width/this.el.offsetWidth;this.ontranslate({dx:i[0]/r,dy:i[1]/r,e:e})}}up(e){if(this.pointerStart){if("function"==typeof this.ondrag){let[t,s]=[e.pageX,e.pageY],i=[t-this.pointerStart[0],s-this.pointerStart[1]],r=this.el.getBoundingClientRect().width/this.el.offsetWidth;this.ondrag({dx:i[0]/r,dy:i[1]/r,e:e})}this.pointerStart=null}}}class z{get frameDimensions(){return[0,0]}get imageDimensions(){return[0,0]}get maskSVG(){return""}saveProperties(e){e.mask={size:this.imageDimensions}}}class j extends z{constructor({size:e=300}){super(),this.size=e}get frameDimensions(){return[this.size,this.size]}get imageDimensions(){return this.frameDimensions}}class A extends b{constructor(e){super(),this.translation=[0,0],this.scaleFactor=1,this.mask=e}get template(){return'<div class=\'d-flex justify-content-center position-relative mb-3\'><div class="image-editor border border-primary rounded">\n                                <div class="canvas">\n                                    <img src="" alt=\'\'>\n                                    <div class="backdrop">&nbsp;</div>\n                                </div>\n                                <div class="im-tools w-100 d-flex justify-content-center">\n                                    <div class="slidecontainer">\n                                        <label for="image-editor-scale-range" class="sr-only"></label>\n                                        <input type="range" min="1" max="100" value="50" class="slider" id="image-editor-scale-range">\n                                    </div>\n                                </div>\n                            </div></div>'}setMask(e){e instanceof z?(this.mask=e,this.bound.find(".image-editor").css("width",e.frameDimensions[0]+"px").css("height",e.frameDimensions[1]+"px"),this.backdrop[0].style.background='url("data:image/svg+xml;utf8,<svg xmlns=\\"http://www.w3.org/2000/svg\\" viewBox=\\"0 0 '+e.frameDimensions[0]+" "+e.frameDimensions[1]+'\\"><path d=\\"'+e.maskSVG+'\\"></path></svg>"'):this.setMask(new j)}reset(){this.translation=[0,0],this.scaleFactor=1,this.boundImage.css("top",0).css("left",0).css("transform","scale(1)")}bindTemplate(e){super.bindTemplate(e),this.bound=e,this.canvas=e.find(".canvas"),this.backdrop=e.find(".backdrop"),this.setMask(this.mask),this.scaleEl=e.find("input[type='range']"),this.scaleEl.on("input",()=>this.scale()),this.drag=new D(this.canvas[0],e=>this.translate(e),null,e=>this.dragComplete(e))}scale(){let e=.02*this.scaleEl.val();e*=e,this.scaleFactor=e,this.boundImage.css("transform","scale("+e+")")}translate({dx:e,dy:t}){const[s,i]=this.translation;this.boundImage.css("top",i+t+"px").css("left",s+e+"px")}dragComplete({dx:e,dy:t}){const[s,i]=this.translation;this.translation=[s+e,i+t]}saveProperties(e){e.translation=this.translation,e.scale=this.scaleFactor,e.frame=this.mask.imageDimensions,this.mask.saveProperties(e)}}class F extends j{constructor({size:e=200,grid:t=10}){super({size:e}),this.grid=t}get maskSVG(){const[e,t,s,i]=[this.size,this.size/2,this.size/2-this.grid,2*(this.size/2-this.grid)];return"M 0,0 l"+e+",0 l 0, "+t+" l -"+this.grid+", 0 a "+s+","+s+" 0 1, 0 -"+i+", 0 a "+s+","+s+" 0 1, 0 "+i+", 0 l"+this.grid+",0 l 0,"+t+" l-"+e+",0z"}}class L extends j{constructor({width:e=1024}){super({size:e}),this.q=9/16}get imageDimensions(){return[this.size,this.size*this.q]}get maskSVG(){const[e,t]=[this.size,Math.abs(this.size-this.size*this.q)/2];return"M0,0 l"+e+",0 l0,"+t+" l-"+e+",0 M 0,"+e+" l"+e+",0 0,-"+t+" -"+e+",0z"}}class R extends L{constructor({width:e=1024}){super({width:e}),this.q=3/4}}class B{get name(){return""}install(e,t){}}if(!window.Skyline||!window.Skyline.API)throw new Error("The skyline component 'image-capture' requires component Skyline.API");var U,G=window.Skyline.API;class Q extends B{constructor(e,t){super(),this.reference=t,this.target=e}get name(){return"api-save"}install(e,t){e.on("save",({file:e,options:t,properties:s,progress:i,done:r,error:n})=>{const a=new FormData;void 0!==this.reference&&a.append("ic-ref",this.reference),a.append("ic-file",e),a.append("ic-options",t),a.append("ic-props",JSON.stringify(s)),a.append("ic-slug",i.slug),G.post(this.target,a).error(n).done(()=>{i(1),r()}).upload(e=>{i(e/100)})})}}U=window.Skyline,Object.assign(U,{ImageCapture:k,Source:{Source:v,LocalFileSource:M,RemoteFileSource:O,CameraSource:P},Frame:{Frame:b,DisplayOnlyFrame:w,EditorFrame:A},Mask:{Mask:z,MaskDefault:j,MaskCircle:F,Mask16_9:L,Mask4_3:R},Checker:{FileChecker:n,QualityChecker:o,RatioChecker:l,DimensionChecker:c,FileSizeChecker:E},Property:{Property:p,TextFieldProperty:x,TextAreaProperty:I,SlugTextFieldProperty:S},Option:{Option:C,DisabledOption:T},Plugin:{Plugin:B,PerformAPISavePlugin:Q}})}])}));